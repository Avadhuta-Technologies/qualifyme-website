---
import Layout from '../../../layouts/Layout.astro';
import Container from '../../../components/Container.astro';
import BlogCard from '../../../components/BlogCard.astro';
import { getBlogBySlug, getRelatedBlogs, formatDate, calculateReadingTime } from '../../../utils/blog-helpers';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const allBlogs = await getCollection('blog', ({ data }) => {
    return !data.draft;
  });

  return allBlogs.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props;
const { slug } = Astro.params;

if (!post) {
  return Astro.redirect('/resources/blog');
}

const relatedBlogs = await getRelatedBlogs(post, 3);
// Calculate reading time from raw body content before rendering
const readingTime = calculateReadingTime(post.body);
const { Content } = await post.render();
---

<Layout
  title={`${post.data.title} - QualifyMe Blog`}
  description={post.data.description}
  keywords={`${post.data.title}, ${post.data.category}, ${post.data.tags?.join(', ') || ''}, QualifyMe blog, AI recruitment`}
  ogImage={post.data.thumbnail || '/images/qualifyme-portal.avif'}
  canonicalURL={`https://qualifyme.ai/resources/blog/${slug}`}
>
  <main class="space-y-20 mb-20">
    {/* Article Header */}
    <section class="pt-20">
      <Container>
        {/* Breadcrumb Navigation */}
        <nav
          class="text-sm text-gray-600 dark:text-gray-300 mb-8"
          aria-label="Breadcrumb"
        >
          <ol class="flex items-center space-x-2">
            <li>
              <a
                href="/"
                class="hover:text-primary transition-colors"
              >
                Home
              </a>
            </li>
            <li class="flex items-center">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="w-4 h-4 mx-2"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 5l7 7-7 7"
                />
              </svg>
              <a
                href="/resources"
                class="hover:text-primary transition-colors"
              >
                Resources
              </a>
            </li>
            <li class="flex items-center">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="w-4 h-4 mx-2"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 5l7 7-7 7"
                />
              </svg>
              <a
                href="/resources/blog"
                class="hover:text-primary transition-colors"
              >
                Blog
              </a>
            </li>
            <li class="flex items-center">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="w-4 h-4 mx-2"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 5l7 7-7 7"
                />
              </svg>
              <span class="text-gray-500 dark:text-gray-400 line-clamp-1">
                {post.data.title}
              </span>
            </li>
          </ol>
        </nav>

        {/* Featured Image */}
        {post.data.thumbnail && (
          <div class="mb-8 rounded-3xl overflow-hidden">
            <img
              src={post.data.thumbnail}
              alt={post.data.title}
              class="w-full h-auto object-cover"
              loading="eager"
            />
          </div>
        )}

        {/* Article Title */}
        <div class="max-w-3xl mx-auto mb-8">
          <div class="text-center md:text-left">
            {/* Category Badge */}
            <div class="mb-4">
              <span class="inline-flex items-center px-4 py-2 rounded-full text-sm font-medium bg-primary/10 text-primary dark:bg-primary/20">
                {post.data.category}
              </span>
            </div>

            <h1 class="text-4xl md:text-5xl font-bold text-gray-800 dark:text-white my-4">
              {post.data.title}
            </h1>

            {/* Meta Information */}
            <div class="flex flex-wrap items-center justify-center md:justify-start gap-4 text-gray-600 dark:text-gray-300 text-sm mb-6">
              <div class="flex items-center gap-2">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="w-5 h-5"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
                  />
                </svg>
                <span>{post.data.author}</span>
              </div>
              <div class="flex items-center gap-2">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="w-5 h-5"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
                  />
                </svg>
                <span>{formatDate(post.data.publishDate)}</span>
              </div>
              <div class="flex items-center gap-2">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="w-5 h-5"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
                  />
                </svg>
                <span>{readingTime} min read</span>
              </div>
            </div>

            {/* Tags */}
            {post.data.tags && post.data.tags.length > 0 && (
              <div class="flex flex-wrap gap-2 justify-center md:justify-start mb-6">
                {post.data.tags.map((tag) => (
                  <a
                    href={`/resources/blog?tags=${encodeURIComponent(tag)}`}
                    class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-primary hover:text-white transition-colors"
                  >
                    #{tag}
                  </a>
                ))}
              </div>
            )}
          </div>
        </div>
      </Container>
    </section>

    {/* Article Content */}
    <section class="pb-10">
      <Container>
        <div class="max-w-3xl mx-auto">
          <article id="blog-content" class="prose prose-lg dark:prose-invert max-w-none prose-headings:text-gray-800 dark:prose-headings:text-white prose-a:text-primary hover:prose-a:text-primary/80 prose-strong:text-gray-800 dark:prose-strong:text-white prose-code:text-primary prose-code:bg-gray-100 dark:prose-code:bg-gray-800 dark:prose-code:text-gray-200 prose-pre:bg-gray-100 dark:prose-pre:bg-gray-800 dark:prose-pre:text-gray-200 prose-blockquote:border-primary prose-blockquote:bg-gray-50 dark:prose-blockquote:bg-gray-800/50 dark:prose-blockquote:text-gray-300 prose-img:rounded-2xl prose-li:text-gray-600 dark:prose-li:text-gray-300 prose-ul:text-gray-600 dark:prose-ul:text-gray-300 prose-ol:text-gray-600 dark:prose-ol:text-gray-300 prose-hr:border-gray-200 dark:prose-hr:border-gray-700">
            <Content />
          </article>
        </div>
      </Container>
    </section>

<style is:global>
  /* CRITICAL FIX: Override prose plugin's generated CSS directly */
  /* Prose generates: .prose p { color: #374151 } and .dark .prose p { color: #e5e7eb } */
  /* But we're seeing #4b5563, which means prose might be generating different CSS */
  /* We need to override the exact selectors prose uses */
  
  /* First, override prose's base styles */
  .prose p {
    color: #374151 !important;
  }
  
  /* Then override prose's dark mode styles - this is the key fix */
  .dark .prose p,
  .dark .prose-lg p,
  .dark .prose.prose-lg p {
    color: #d1d5db !important;
  }
  
  /* Now target our specific blog-content element with maximum specificity */
  .dark #blog-content p,
  .dark #blog-content.prose p,
  .dark #blog-content.prose-lg p,
  .dark #blog-content.prose.prose-lg p,
  .dark body #blog-content p,
  .dark body #blog-content.prose p,
  .dark body #blog-content.prose-lg p,
  .dark body #blog-content.prose.prose-lg p,
  .dark html body #blog-content p,
  .dark html body #blog-content.prose p,
  .dark html body #blog-content.prose-lg p,
  .dark html body #blog-content.prose.prose-lg p {
    color: #d1d5db !important;
  }
  
  /* Override prose plugin's selectors directly */
  .dark .prose #blog-content p,
  .dark .prose-lg #blog-content p,
  .dark .prose.prose-lg #blog-content p {
    color: #d1d5db !important;
  }
  
  /* Override prose utility classes directly */
  .dark #blog-content p.prose-p,
  .dark #blog-content.prose p.prose-p,
  .dark #blog-content.prose-lg p.prose-p,
  .dark #blog-content.prose.prose-lg p.prose-p {
    color: #d1d5db !important;
  }
  
  /* Override any inline styles or computed styles */
  .dark #blog-content p[style],
  .dark #blog-content.prose p[style],
  .dark #blog-content.prose-lg p[style],
  .dark #blog-content.prose.prose-lg p[style] {
    color: #d1d5db !important;
  }
  
  /* Target all paragraph elements regardless of classes */
  .dark #blog-content p[class],
  .dark #blog-content.prose p[class],
  .dark #blog-content.prose-lg p[class],
  .dark #blog-content.prose.prose-lg p[class] {
    color: #d1d5db !important;
  }
  
  /* Nuclear option - target all p elements inside blog-content in dark mode */
  .dark #blog-content article p,
  .dark #blog-content article.prose p,
  .dark #blog-content article.prose-lg p,
  .dark #blog-content article.prose.prose-lg p {
    color: #d1d5db !important;
  }
  
  /* Override prose-p utility class color */
  .dark #blog-content .prose-p\:text-gray-600,
  .dark #blog-content.prose .prose-p\:text-gray-600 {
    color: #d1d5db !important;
  }
  
  /* Force color on all text elements in dark mode */
  .dark #blog-content {
    color: #d1d5db !important;
  }
  
  .dark #blog-content * {
    color: inherit;
  }
  
  .dark #blog-content p,
  .dark #blog-content div,
  .dark #blog-content span,
  .dark #blog-content li {
    color: #d1d5db !important;
  }
  
  /* But preserve special element colors */
  .dark #blog-content a {
    color: #3b82f6 !important;
  }
  
  .dark #blog-content h1,
  .dark #blog-content h2,
  .dark #blog-content h3,
  .dark #blog-content h4,
  .dark #blog-content h5,
  .dark #blog-content h6 {
    color: #ffffff !important;
  }
  
  .dark #blog-content strong {
    color: #ffffff !important;
  }
  
  .dark #blog-content code {
    color: #e5e7eb !important;
  }
  
  /* Override prose plugin generated CSS - must be last */
  .dark .prose #blog-content p,
  .dark .prose-lg #blog-content p,
  .dark .prose.prose-lg #blog-content p,
  .dark #blog-content.prose p,
  .dark #blog-content.prose-lg p,
  .dark #blog-content.prose.prose-lg p {
    color: #d1d5db !important;
  }
  
  /* Final override - target any p element inside blog-content when dark mode is active */
  html.dark #blog-content p,
  html.dark #blog-content.prose p,
  html.dark #blog-content.prose-lg p,
  html.dark #blog-content.prose.prose-lg p,
  body.dark #blog-content p,
  body.dark #blog-content.prose p,
  body.dark #blog-content.prose-lg p,
  body.dark #blog-content.prose.prose-lg p {
    color: #d1d5db !important;
  }
  
  /* ABSOLUTE FINAL OVERRIDE - This must override everything including prose plugin CSS */
  /* Target the exact selector prose uses: .dark .prose p */
  .dark .prose p,
  .dark .prose-lg p,
  .dark .prose.prose-lg p,
  .dark #blog-content.prose p,
  .dark #blog-content.prose-lg p,
  .dark #blog-content.prose.prose-lg p,
  .dark .prose #blog-content p,
  .dark .prose-lg #blog-content p,
  .dark .prose.prose-lg #blog-content p {
    color: #d1d5db !important;
  }
  
  /* Nuclear option - override ALL p elements inside prose in dark mode */
  .dark .prose p,
  .dark .prose-lg p,
  .dark .prose.prose-lg p {
    color: #d1d5db !important;
  }
  
  /* Ensure this applies to our specific element */
  .dark #blog-content.prose p,
  .dark #blog-content.prose-lg p,
  .dark #blog-content.prose.prose-lg p {
    color: #d1d5db !important;
  }
</style>

<script>
  // Force dark mode text colors if CSS isn't working
  // This is a fallback to ensure all text elements get the correct color in dark mode
  function applyDarkModeColors() {
    // Check if dark mode is active
    const isDarkMode = document.documentElement.classList.contains('dark') || 
                       document.body.classList.contains('dark') ||
                       (document.documentElement.style.colorScheme === 'dark') ||
                       window.matchMedia('(prefers-color-scheme: dark)').matches;
    
    if (isDarkMode) {
      const blogContent = document.getElementById('blog-content');
      if (blogContent) {
        // Function to check and fix color for an element
        function fixElementColor(element: Element, targetColor: string) {
          const el = element as HTMLElement;
          const computedColor = window.getComputedStyle(el).color;
          const rgb = computedColor.match(/\d+/g);
          if (rgb && rgb.length >= 3) {
            const r = parseInt(rgb[0]);
            const g = parseInt(rgb[1]);
            const b = parseInt(rgb[2]);
            // If it's a dark gray (like #4b5563 which is rgb(75, 85, 99)), force light color
            if (r < 100 && g < 100 && b < 100 && r > 50 && g > 50 && b > 50) {
              el.style.setProperty('color', targetColor, 'important');
            }
          }
        }
        
        // Fix paragraphs - light gray
        const paragraphs = blogContent.querySelectorAll('p');
        paragraphs.forEach(p => fixElementColor(p, '#d1d5db'));
        
        // Fix headings - white
        const headings = blogContent.querySelectorAll('h1, h2, h3, h4, h5, h6');
        headings.forEach(h => {
          const heading = h as HTMLElement;
          const computedColor = window.getComputedStyle(heading).color;
          const rgb = computedColor.match(/\d+/g);
          if (rgb && rgb.length >= 3) {
            const r = parseInt(rgb[0]);
            const g = parseInt(rgb[1]);
            const b = parseInt(rgb[2]);
            // If it's a dark color (like #1f2937 which is rgb(31, 41, 55)), force white
            if (r < 100 && g < 100 && b < 100) {
              heading.style.setProperty('color', '#ffffff', 'important');
            }
          }
        });
        
        // Fix list items - light gray
        const listItems = blogContent.querySelectorAll('li');
        listItems.forEach(li => fixElementColor(li, '#d1d5db'));
        
        // Fix lists (ul, ol) - light gray
        const lists = blogContent.querySelectorAll('ul, ol');
        lists.forEach(list => fixElementColor(list, '#d1d5db'));
        
        // Fix blockquotes - light gray
        const blockquotes = blogContent.querySelectorAll('blockquote');
        blockquotes.forEach(blockquote => fixElementColor(blockquote, '#d1d5db'));
        
        // Fix divs and spans (text containers) - light gray
        const divs = blogContent.querySelectorAll('div, span');
        divs.forEach(div => {
          // Only fix if it's not a special element (like code, pre, strong, etc.)
          if (!div.closest('code') && !div.closest('pre') && !div.closest('strong') && 
              !div.closest('a') && !div.closest('h1, h2, h3, h4, h5, h6')) {
            fixElementColor(div, '#d1d5db');
          }
        });
        
        // Fix table cells - light gray
        const tableCells = blogContent.querySelectorAll('td, th');
        tableCells.forEach(cell => fixElementColor(cell, '#d1d5db'));
        
        // Fix strong/bold - white
        const strongElements = blogContent.querySelectorAll('strong, b');
        strongElements.forEach(strong => {
          const strongEl = strong as HTMLElement;
          const computedColor = window.getComputedStyle(strongEl).color;
          const rgb = computedColor.match(/\d+/g);
          if (rgb && rgb.length >= 3) {
            const r = parseInt(rgb[0]);
            const g = parseInt(rgb[1]);
            const b = parseInt(rgb[2]);
            // If it's a dark color, force white
            if (r < 100 && g < 100 && b < 100) {
              strongEl.style.setProperty('color', '#ffffff', 'important');
            }
          }
        });
        
        // Fix code - light gray (but preserve code block styling)
        const codeElements = blogContent.querySelectorAll('code:not(pre code)');
        codeElements.forEach(code => {
          const codeEl = code as HTMLElement;
          const computedColor = window.getComputedStyle(codeEl).color;
          const rgb = computedColor.match(/\d+/g);
          if (rgb && rgb.length >= 3) {
            const r = parseInt(rgb[0]);
            const g = parseInt(rgb[1]);
            const b = parseInt(rgb[2]);
            // If it's a dark color, force light gray
            if (r < 100 && g < 100 && b < 100) {
              codeEl.style.setProperty('color', '#e5e7eb', 'important');
            }
          }
        });
        
        // Fix pre blocks - light gray
        const preElements = blogContent.querySelectorAll('pre');
        preElements.forEach(pre => {
          const computedColor = window.getComputedStyle(pre).color;
          const rgb = computedColor.match(/\d+/g);
          if (rgb && rgb.length >= 3) {
            const r = parseInt(rgb[0]);
            const g = parseInt(rgb[1]);
            const b = parseInt(rgb[2]);
            // If it's a dark color, force light gray
            if (r < 100 && g < 100 && b < 100) {
              pre.style.setProperty('color', '#e5e7eb', 'important');
            }
          }
        });
      }
    }
  }
  
  // Run on DOMContentLoaded
  document.addEventListener('DOMContentLoaded', applyDarkModeColors);
  
  // Also run after a short delay to catch any late-rendered content
  setTimeout(applyDarkModeColors, 100);
  setTimeout(applyDarkModeColors, 500);
  
  // Watch for dark mode changes
  const darkModeObserver = new MutationObserver(applyDarkModeColors);
  darkModeObserver.observe(document.documentElement, {
    attributes: true,
    attributeFilter: ['class']
  });
  darkModeObserver.observe(document.body, {
    attributes: true,
    attributeFilter: ['class']
  });
  
  // Watch for content changes in blog-content
  const blogContentObserver = new MutationObserver(applyDarkModeColors);
  const blogContent = document.getElementById('blog-content');
  if (blogContent) {
    blogContentObserver.observe(blogContent, {
      childList: true,
      subtree: true
    });
  }
</script>

    {/* Related Posts */}
    {relatedBlogs.length > 0 && (
      <section class="py-10">
        <Container>
          <h2 class="text-3xl font-bold text-gray-800 dark:text-white mb-8">
            Related Posts
          </h2>
          <div class="grid gap-8 md:grid-cols-2 lg:grid-cols-3">
            {relatedBlogs.map((relatedPost) => (
              <BlogCard post={relatedPost} />
            ))}
          </div>
        </Container>
      </section>
    )}

    {/* Navigation */}
    <section class="py-10">
      <Container>
        <div class="max-w-3xl mx-auto">
          <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
            <a
              href="/resources/blog"
              class="inline-flex items-center text-primary hover:underline font-semibold"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="w-5 h-5 mr-2"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M15 19l-7-7 7-7"
                />
              </svg>
              Back to Blog
            </a>

            <div class="flex items-center gap-4">
              <a
                href="/contact"
                class="inline-flex items-center text-gray-600 dark:text-gray-300 hover:text-primary transition-colors"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="w-4 h-4 mr-2"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                  />
                </svg>
                Need Help?
              </a>
              <a
                href="https://console.qualifyme.ai"
                class="inline-flex items-center text-primary hover:text-primary/80 transition-colors font-semibold"
              >
                <span>Try QualifyMe</span>
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="w-4 h-4 ml-1"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 5l7 7-7 7"
                  />
                </svg>
              </a>
            </div>
          </div>
        </div>
      </Container>
    </section>
  </main>
</Layout>

<!-- Structured Data for SEO -->
<script
  type="application/ld+json"
  set:html={JSON.stringify({
    '@context': 'https://schema.org',
    '@type': 'BlogPosting',
    headline: post.data.title,
    description: post.data.description,
    image: post.data.thumbnail
      ? new URL(post.data.thumbnail, 'https://qualifyme.ai').toString()
      : 'https://qualifyme.ai/images/qualifyme-portal.avif',
    datePublished: post.data.publishDate.toISOString(),
    dateModified: post.data.publishDate.toISOString(),
    author: {
      '@type': 'Organization',
      name: post.data.author || 'QualifyMe Team',
      url: 'https://qualifyme.ai',
    },
    publisher: {
      '@type': 'Organization',
      name: 'QualifyMe',
      logo: {
        '@type': 'ImageObject',
        url: 'https://qualifyme.ai/logo_white.png',
      },
    },
    mainEntityOfPage: {
      '@type': 'WebPage',
      '@id': `https://qualifyme.ai/resources/blog/${slug}`,
    },
    articleSection: post.data.category,
    keywords: post.data.tags?.join(', ') || '',
  })}
/>

